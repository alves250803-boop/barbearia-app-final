<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barbearia Marcos - Agendamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { gold: '#d4af37', dark: '#121212', darker: '#0a0a0a', card: '#1e1e1e', input: '#2a2a2a' },
                    fontFamily: { sans: ['Roboto', 'sans-serif'], display: ['Oswald', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #121212; color: #e5e5e5; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .service-checkbox:checked + div { border-color: #d4af37; background-color: rgba(212, 175, 55, 0.1); }
        .time-radio:checked + div { background-color: #d4af37; color: #000; border-color: #d4af37; font-weight: bold; }
    </style>
</head>
<body class="h-screen overflow-hidden font-sans">

    <script>
        // --- SUBSTITUA PELA SUA CONFIGURAÇÃO FIREBASE AQUI ---
        const firebaseConfig = {
            apiKey: "AIzaSyCrHzXxwwTyTGVbxRin9GoD6Rqfz6NeWTU",
            authDomain: "barbeariamarcos-4acc2.firebaseapp.com",
            projectId: "barbeariamarcos-4acc2",
            storageBucket: "barbeariamarcos-4acc2.firebasestorage.app",
            messagingSenderId: "283555161596",
            appId: "1:283555161596:web:f1de921877c0eea4417e79"
        };
        // -----------------------------------------------------

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <section id="auth-screen" class="w-full h-full flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1638383257225-f810a62c634e?q=80&w=1287')] bg-cover bg-center relative">
        <div class="absolute inset-0 bg-darker/90"></div>
        <div class="relative z-10 w-full max-w-md p-6 fade-in">
            <div class="text-center mb-8">
                <h1 class="font-display text-5xl text-gold font-bold mb-2">MARCOS<br><span class="text-white text-3xl">BARBEARIA</span></h1>
                <p class="text-gray-400">Entre para agendar.</p>
            </div>
            <div class="bg-card border border-gray-800 p-8 rounded-2xl shadow-2xl">
                <form id="login-form" class="space-y-6" onsubmit="event.preventDefault(); handleLogin();">
                    <h2 class="text-2xl text-white font-display">Login</h2>
                    <input type="email" id="login-email" class="w-full bg-input rounded p-3 text-white border border-gray-700" placeholder="Email" required>
                    <input type="password" id="login-pass" class="w-full bg-input rounded p-3 text-white border border-gray-700" placeholder="Senha" required>
                    <button type="submit" class="w-full bg-gold hover:bg-yellow-600 text-darker font-bold py-3 rounded">ENTRAR</button>
                    <p class="text-center text-sm text-gray-400 mt-4 cursor-pointer hover:text-white" onclick="toggleAuthMode()">Não tem conta? Registre-se</p>
                </form>
                <form id="register-form" class="space-y-6 hidden" onsubmit="event.preventDefault(); handleRegister();">
                    <h2 class="text-2xl text-white font-display">Criar Conta</h2>
                    <input type="text" id="reg-name" class="w-full bg-input rounded p-3 text-white border border-gray-700" placeholder="Nome Completo" required>
                    <input type="email" id="reg-email" class="w-full bg-input rounded p-3 text-white border border-gray-700" placeholder="Email" required>
                    <input type="password" id="reg-pass" class="w-full bg-input rounded p-3 text-white border border-gray-700" placeholder="Senha (min 6 carac.)" required>
                    <button type="submit" class="w-full bg-gold hover:bg-yellow-600 text-darker font-bold py-3 rounded">CADASTRAR</button>
                    <p class="text-center text-sm text-gray-400 mt-4 cursor-pointer hover:text-white" onclick="toggleAuthMode()">Voltar para Login</p>
                </form>
            </div>
        </div>
    </section>

    <div id="app-screen" class="hidden flex-col md:flex-row h-screen overflow-hidden">
        <nav class="bg-darker border-r border-gray-800 w-full md:w-64 h-16 md:h-full fixed bottom-0 md:relative z-50 flex md:flex-col justify-between p-6 shadow-2xl">
            <div class="hidden md:block w-full">
                <h1 class="font-display text-2xl text-gold font-bold mb-6">MARCOS<br><span class="text-white text-lg">BARBEARIA</span></h1>
                <div class="bg-gray-900 rounded p-3 flex items-center gap-3 border border-gray-800">
                    <div class="w-8 h-8 rounded-full bg-gold text-darker flex items-center justify-center font-bold" id="user-avatar">U</div>
                    <div class="overflow-hidden">
                        <p class="text-white text-sm font-bold truncate" id="user-name-display">Carregando...</p>
                        <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300">Sair</button>
                    </div>
                </div>
            </div>
            <div class="flex md:flex-col justify-around w-full md:w-auto md:space-y-4 h-full md:h-auto items-center md:items-start">
                <button onclick="switchTab('home')" id="nav-home" class="nav-item text-gold font-bold">Início</button>
                <button onclick="switchTab('agendar')" id="nav-agendar" class="nav-item text-gray-400">Agendar</button>
                <button onclick="switchTab('historico')" id="nav-historico" class="nav-item text-gray-400">Histórico</button>
            </div>
        </nav>

        <main class="flex-1 h-full overflow-y-auto pb-20 md:pb-0 bg-dark relative">
            <div class="md:hidden p-4 bg-darker border-b border-gray-800 flex justify-between items-center sticky top-0 z-40">
                <h1 class="text-gold font-bold">MARCOS BARBEARIA</h1>
                <button onclick="logout()" class="text-red-500 text-xs">Sair</button>
            </div>

            <section id="tab-home" class="tab-content fade-in p-6 md:p-12 min-h-full flex flex-col justify-center relative">
                <div class="relative z-10 max-w-2xl">
                    <h2 class="font-display text-5xl text-white font-bold mb-6">ESTILO E<br>TRADIÇÃO.</h2>
                    <button onclick="switchTab('agendar')" class="bg-gold text-darker font-bold py-3 px-8 rounded hover:scale-105 transition">AGENDAR AGORA</button>
                </div>
            </section>

            <section id="tab-agendar" class="tab-content hidden fade-in p-6 md:p-12 max-w-4xl mx-auto">
                <h2 class="text-3xl text-white font-display mb-6">Novo Agendamento</h2>
                <form onsubmit="event.preventDefault(); confirmarAgendamento();">
                    <h3 class="text-gold font-bold mb-3">1. Profissional</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="barber-list"></div>
                    
                    <h3 class="text-gold font-bold mb-3">2. Serviços</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6" id="services-list"></div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h3 class="text-gold font-bold mb-3">3. Data</h3>
                            <input type="date" id="date-select" class="w-full bg-input text-white p-3 rounded border border-gray-700" onchange="loadAvailableTimes()">
                        </div>
                        <div>
                            <h3 class="text-gold font-bold mb-3">4. Horário</h3>
                            <div class="grid grid-cols-4 gap-2" id="time-slots">
                                <p class="text-gray-500 text-sm col-span-4 italic">Selecione data e barbeiro.</p>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-gold text-darker font-bold py-4 rounded mt-4 hover:bg-yellow-600 transition">CONFIRMAR AGENDAMENTO</button>
                </form>
            </section>

            <section id="tab-historico" class="tab-content hidden fade-in p-6 md:p-12 max-w-4xl mx-auto">
                <h2 class="text-3xl text-white font-display mb-6">Meus Agendamentos</h2>
                <div id="history-list" class="space-y-4">Carregando...</div>
            </section>
        </main>
    </div>

    <script>
        // DADOS
        const barbers = [
            { name: 'Renan Silva', img: 'https://randomuser.me/api/portraits/men/32.jpg' },
            { name: 'Marcos Dias', img: 'https://randomuser.me/api/portraits/men/33.jpg' },
            { name: 'André Luiz', img: 'https://randomuser.me/api/portraits/men/36.jpg' },
            { name: 'Júnior', img: 'https://randomuser.me/api/portraits/men/50.jpg' }
        ];
        const services = [
            { id: 'corte', name: 'Corte de Cabelo', price: 50 },
            { id: 'barba', name: 'Barba', price: 40 },
            { id: 'combo', name: 'Cabelo + Barba', price: 80 }
        ];

        let selectedBarber = null;
        let selectedServices = [];
        let selectedTime = null;
        let currentUser = null;

        // AUTH LISTENER
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('flex');
                
                // Redirecionamento Admin
                if(user.email === 'barbeiro2003@gmail.com') { // Email em minúsculo
                    window.location.href = 'painel.html';
                }

                document.getElementById('user-name-display').innerText = user.displayName || user.email;
                renderBarbers();
                renderServices();
                loadHistory();
            } else {
                document.getElementById('app-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('flex');
                document.getElementById('auth-screen').classList.remove('hidden');
            }
        });

        // AUTH FUNCTIONS
        function toggleAuthMode() {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('register-form').classList.toggle('hidden');
        }

        function handleLogin() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            auth.signInWithEmailAndPassword(email, pass).catch(e => alert("Erro: " + e.message));
        }

        function handleRegister() {
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            const name = document.getElementById('reg-name').value;
            
            auth.createUserWithEmailAndPassword(email, pass).then(cred => {
                return cred.user.updateProfile({ displayName: name });
            }).catch(e => alert("Erro: " + e.message));
        }

        function logout() {
            auth.signOut();
        }

        // APP LOGIC
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.className = 'nav-item text-gray-400 cursor-pointer');
            document.getElementById(`nav-${tab}`).className = 'nav-item text-gold font-bold cursor-pointer';
        }

        function renderBarbers() {
            document.getElementById('barber-list').innerHTML = barbers.map(b => `
                <label class="cursor-pointer">
                    <input type="radio" name="barber" value="${b.name}" class="peer sr-only" onchange="selectedBarber='${b.name}'; loadAvailableTimes();">
                    <div class="bg-card p-4 rounded text-center border-2 border-transparent peer-checked:border-gold peer-checked:bg-gray-800">
                        <img src="${b.img}" class="w-16 h-16 rounded-full mx-auto mb-2">
                        <div class="text-white font-bold text-sm">${b.name}</div>
                    </div>
                </label>
            `).join('');
        }

        function renderServices() {
            document.getElementById('services-list').innerHTML = services.map(s => `
                <label class="cursor-pointer">
                    <input type="checkbox" value="${s.id}" class="peer sr-only service-checkbox" onchange="toggleService('${s.id}', '${s.name}', ${s.price})">
                    <div class="bg-card p-4 rounded border border-gray-700 flex justify-between items-center">
                        <div class="text-white font-bold text-sm">${s.name}</div>
                        <div class="text-gold text-xs">R$ ${s.price}</div>
                    </div>
                </label>
            `).join('');
        }

        function toggleService(id, name, price) {
            const idx = selectedServices.findIndex(x => x.id === id);
            if(idx > -1) selectedServices.splice(idx, 1);
            else selectedServices.push({id, name, price});
        }

        async function loadAvailableTimes() {
            const date = document.getElementById('date-select').value;
            const container = document.getElementById('time-slots');
            container.innerHTML = '';
            selectedTime = null;

            if(!selectedBarber || !date) return;

            // 1. Verificar configuração do barbeiro (Escala)
            const configDoc = await db.collection('schedules').doc(`${date}_${selectedBarber}`).get();
            const defaultSlots = ['09:00', '10:00', '11:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00'];
            let activeSlots = configDoc.exists ? configDoc.data().slots : defaultSlots;

            // 2. Verificar agendamentos existentes no banco
            const snapshot = await db.collection('appointments')
                .where('barber', '==', selectedBarber)
                .where('date', '==', date)
                .where('status', '!=', 'Cancelado')
                .get();
            
            const busyTimes = snapshot.docs.map(doc => doc.data().time);

            container.innerHTML = defaultSlots.map(time => {
                const isBusy = busyTimes.includes(time);
                const isBlocked = !activeSlots.includes(time);
                
                // Verifica passado
                const now = new Date();
                const [h, m] = time.split(':');
                const slotDate = new Date(`${date}T${time}`);
                const isPast = slotDate < now;

                if(isBusy || isBlocked || isPast) {
                    return `<div class="py-2 text-center rounded bg-gray-900 text-gray-600 text-sm line-through cursor-not-allowed">${time}</div>`;
                }
                return `
                    <label class="cursor-pointer">
                        <input type="radio" name="time" value="${time}" class="peer sr-only time-radio" onchange="selectedTime='${time}'">
                        <div class="py-2 text-center rounded border border-gray-700 text-gray-300 text-sm hover:border-gold transition-colors">${time}</div>
                    </label>
                `;
            }).join('');
        }

        async function confirmarAgendamento() {
            if(!selectedBarber || !selectedTime || selectedServices.length === 0) return alert("Preencha tudo!");

            const total = selectedServices.reduce((a, b) => a + b.price, 0);
            
            try {
                // Verificação final de concorrência
                const check = await db.collection('appointments')
                    .where('barber', '==', selectedBarber)
                    .where('date', '==', document.getElementById('date-select').value)
                    .where('time', '==', selectedTime)
                    .where('status', '!=', 'Cancelado')
                    .get();

                if(!check.empty) return alert("Ops! Alguém acabou de reservar esse horário.");

                await db.collection('appointments').add({
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email,
                    barber: selectedBarber,
                    services: selectedServices.map(s => s.name).join(', '),
                    date: document.getElementById('date-select').value,
                    time: selectedTime,
                    total: total,
                    status: 'Confirmado',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert("Agendamento Confirmado!");
                switchTab('historico');
                // Reset form
                selectedServices = [];
                selectedBarber = null;
                selectedTime = null;
                document.getElementById('date-select').value = '';
                document.getElementById('time-slots').innerHTML = '';
            } catch(e) {
                console.error(e);
                alert("Erro ao agendar.");
            }
        }

        function loadHistory() {
            db.collection('appointments')
                .where('userId', '==', currentUser.uid)
                .orderBy('date', 'desc')
                .onSnapshot(snapshot => {
                    const list = document.getElementById('history-list');
                    if(snapshot.empty) {
                        list.innerHTML = '<p class="text-gray-500 text-center">Nenhum agendamento.</p>';
                        return;
                    }

                    list.innerHTML = snapshot.docs.map(doc => {
                        const d = doc.data();
                        const color = d.status === 'Cancelado' ? 'text-red-500' : (d.status === 'Concluído' ? 'text-green-500' : 'text-blue-500');
                        
                        // Formata Data
                        const dateParts = d.date.split('-'); // YYYY-MM-DD
                        const dateBr = `${dateParts[2]}/${dateParts[1]}`;

                        return `
                        <div class="bg-card border-l-4 ${d.status === 'Cancelado' ? 'border-red-500' : 'border-gold'} p-4 rounded shadow flex justify-between items-center">
                            <div>
                                <h4 class="font-bold text-white">${d.barber}</h4>
                                <p class="text-xs text-gray-400">${d.services}</p>
                                <div class="text-gold font-mono text-sm mt-1">${dateBr} às ${d.time}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-white">R$ ${d.total}</div>
                                <div class="text-xs font-bold uppercase ${color}">${d.status}</div>
                                ${d.status === 'Confirmado' ? `<button onclick="cancelAppt('${doc.id}')" class="text-xs text-red-400 mt-2 underline">Cancelar</button>` : ''}
                            </div>
                        </div>`;
                    }).join('');
                });
        }

        function cancelAppt(id) {
            if(confirm("Deseja cancelar?")) {
                db.collection('appointments').doc(id).update({ status: 'Cancelado' });
            }
        }
    </script>
</body>
</html>

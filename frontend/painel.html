<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Barbearia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = { theme: { extend: { colors: { gold: '#d4af37', dark: '#121212', darker: '#0a0a0a', card: '#1e1e1e', input: '#2a2a2a' } } } }
    </script>
    <style>body { background-color: #0a0a0a; color: #e5e5e5; }</style>
</head>
<body class="h-screen flex font-sans bg-darker">

    <script>
        // --- SUBSTITUA PELA MESMA CONFIGURAÇÃO DO INDEX.HTML ---
        const firebaseConfig = {
            apiKey: "SUA_API_KEY_AQUI",
            authDomain: "SEU_PROJETO.firebaseapp.com",
            projectId: "SEU_PROJETO_ID",
            storageBucket: "SEU_PROJETO.appspot.com",
            messagingSenderId: "NUMERO",
            appId: "ID_DO_APP"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <aside class="w-64 bg-card border-r border-gray-800 flex flex-col hidden md:flex">
        <div class="p-6 text-center border-b border-gray-800">
            <h1 class="text-xl text-gold font-bold">PAINEL ADMIN</h1>
        </div>
        <nav class="flex-1 mt-6 px-4 space-y-2">
            <button onclick="switchTab('dashboard')" class="w-full text-left p-3 rounded bg-gold text-darker font-bold">Dashboard</button>
            <button onclick="switchTab('escala')" class="w-full text-left p-3 rounded text-gray-400 hover:bg-gray-800">Escala</button>
            <button onclick="auth.signOut()" class="w-full text-left p-3 rounded text-red-400 hover:bg-gray-800 mt-10">Sair</button>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden">
        <header class="h-16 border-b border-gray-800 bg-dark flex items-center justify-between px-6">
            <h2 class="text-white font-bold">Barbearia Admin</h2>
            <div id="status-conn" class="text-xs text-green-500">● Conectado</div>
        </header>

        <div class="flex-1 overflow-y-auto p-6">
            
            <section id="tab-dashboard">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-card p-6 rounded border border-gray-800">
                        <p class="text-gray-400 text-xs uppercase">Hoje</p>
                        <h3 class="text-3xl text-white font-bold" id="count-today">0</h3>
                    </div>
                    <div class="bg-card p-6 rounded border border-gray-800">
                        <p class="text-gray-400 text-xs uppercase">Faturamento (Hoje)</p>
                        <h3 class="text-3xl text-green-500 font-bold" id="rev-today">R$ 0,00</h3>
                    </div>
                </div>

                <div class="bg-card border border-gray-800 rounded overflow-hidden">
                    <div class="p-4 border-b border-gray-800 flex justify-between">
                        <h3 class="text-white font-bold">Agendamentos Recentes</h3>
                        <button onclick="loadDashboard()" class="text-gold text-xs">Atualizar</button>
                    </div>
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-gray-900 text-xs uppercase">
                            <tr>
                                <th class="p-4">Data/Hora</th>
                                <th class="p-4">Cliente</th>
                                <th class="p-4">Barbeiro</th>
                                <th class="p-4">Status</th>
                                <th class="p-4">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </section>

            <section id="tab-escala" class="hidden">
                <h2 class="text-2xl text-white mb-6">Configurar Disponibilidade</h2>
                <div class="bg-card p-6 rounded border border-gray-800 max-w-xl">
                    <div class="mb-4">
                        <label class="block text-gold text-xs mb-1">Barbeiro</label>
                        <select id="schedule-barber" class="w-full bg-input text-white p-2 rounded" onchange="loadSchedule()">
                            <option>Renan Silva</option>
                            <option>Marcos Dias</option>
                            <option>André Luiz</option>
                            <option>Júnior</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gold text-xs mb-1">Data</label>
                        <input type="date" id="schedule-date" class="w-full bg-input text-white p-2 rounded" onchange="loadSchedule()">
                    </div>
                    <div class="grid grid-cols-5 gap-2" id="slots-container"></div>
                    <button onclick="saveSchedule()" class="mt-6 w-full bg-gold text-darker font-bold p-3 rounded">SALVAR</button>
                </div>
            </section>

        </div>
    </main>

    <script>
        auth.onAuthStateChanged(user => {
            if (!user) window.location.href = 'index.html';
            else {
                // Segurança extra: verifica email admin
                if(user.email !== 'barbeiro2003@gmail.com') { // Email em minúsculo
                    alert("Acesso não autorizado.");
                    auth.signOut();
                } else {
                    initDashboard();
                }
            }
        });

        function switchTab(tab) {
            document.getElementById('tab-dashboard').classList.add('hidden');
            document.getElementById('tab-escala').classList.add('hidden');
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            if(tab === 'escala') loadSchedule();
        }

        // --- DASHBOARD EM TEMPO REAL ---
        function initDashboard() {
            // Listener para todos os agendamentos
            db.collection('appointments')
                .orderBy('date', 'desc')
                .orderBy('time', 'asc')
                .limit(50)
                .onSnapshot(snapshot => {
                    const tbody = document.getElementById('table-body');
                    tbody.innerHTML = '';
                    
                    let todayCount = 0;
                    let todayRev = 0;
                    const todayStr = new Date().toISOString().split('T')[0];

                    snapshot.forEach(doc => {
                        const d = doc.data();
                        
                        // Stats de hoje
                        if(d.date === todayStr && d.status !== 'Cancelado') {
                            todayCount++;
                            if(d.status === 'Concluído') todayRev += d.total;
                        }

                        // Formata data
                        const dateParts = d.date.split('-');
                        const dateBr = `${dateParts[2]}/${dateParts[1]}`;
                        
                        let color = 'text-blue-500';
                        if(d.status === 'Concluído') color = 'text-green-500';
                        if(d.status === 'Cancelado') color = 'text-red-500';

                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-gray-900';
                        tr.innerHTML = `
                            <td class="p-4 text-white">${dateBr} <span class="text-gold text-xs ml-1">${d.time}</span></td>
                            <td class="p-4">${d.userName}</td>
                            <td class="p-4">${d.barber}</td>
                            <td class="p-4 font-bold text-xs uppercase ${color}">${d.status}</td>
                            <td class="p-4 flex gap-2">
                                <button onclick="updateStatus('${doc.id}', 'Concluído')" class="text-green-500 hover:text-white"><i class="fa-solid fa-check"></i></button>
                                <button onclick="updateStatus('${doc.id}', 'Cancelado')" class="text-red-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });

                    document.getElementById('count-today').innerText = todayCount;
                    document.getElementById('rev-today').innerText = `R$ ${todayRev.toFixed(2)}`;
                });
        }

        function updateStatus(id, status) {
            if(confirm(`Mudar para ${status}?`)) {
                db.collection('appointments').doc(id).update({ status: status });
            }
        }

        // --- ESCALA ---
        const defaultSlots = ['09:00', '10:00', '11:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00'];

        function loadSchedule() {
            const barber = document.getElementById('schedule-barber').value;
            const date = document.getElementById('schedule-date').value || new Date().toISOString().split('T')[0];
            document.getElementById('schedule-date').value = date;

            db.collection('schedules').doc(`${date}_${barber}`).get().then(doc => {
                const active = doc.exists ? doc.data().slots : defaultSlots;
                const container = document.getElementById('slots-container');
                container.innerHTML = defaultSlots.map(time => {
                    const isActive = active.includes(time);
                    return `
                        <div onclick="toggleSlot(this)" data-time="${time}" data-active="${isActive}" 
                            class="cursor-pointer border rounded py-2 text-center text-sm select-none 
                            ${isActive ? 'bg-green-900/30 border-green-500 text-white' : 'bg-red-900/20 border-red-900 text-gray-600'}">
                            ${time}
                        </div>
                    `;
                }).join('');
            });
        }

        function toggleSlot(el) {
            const state = el.getAttribute('data-active') === 'true';
            el.setAttribute('data-active', !state);
            el.className = !state 
                ? "cursor-pointer border rounded py-2 text-center text-sm select-none bg-green-900/30 border-green-500 text-white"
                : "cursor-pointer border rounded py-2 text-center text-sm select-none bg-red-900/20 border-red-900 text-gray-600";
        }

        function saveSchedule() {
            const barber = document.getElementById('schedule-barber').value;
            const date = document.getElementById('schedule-date').value;
            const active = [];
            document.querySelectorAll('#slots-container > div').forEach(el => {
                if(el.getAttribute('data-active') === 'true') active.push(el.getAttribute('data-time'));
            });

            db.collection('schedules').doc(`${date}_${barber}`).set({ slots: active })
                .then(() => alert("Escala salva com sucesso!"))
                .catch(e => alert("Erro ao salvar: " + e.message));
        }
    </script>
</body>
</html>

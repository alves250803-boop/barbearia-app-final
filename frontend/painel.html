<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto Marcos</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gold: '#d4af37',
                        dark: '#121212',
                        darker: '#0a0a0a',
                        card: '#1e1e1e',
                        input: '#2a2a2a',
                        success: '#10b981',
                        danger: '#ef4444'
                    },
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                        display: ['Oswald', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0a0a0a; color: #e5e5e5; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #d4af37; }
        
        /* Transição suave para o menu mobile */
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="h-screen flex overflow-hidden font-sans bg-darker">

    <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 z-40 hidden md:hidden backdrop-blur-sm"></div>

    <aside id="sidebar" class="sidebar-transition fixed inset-y-0 left-0 w-72 bg-card border-r border-gray-800 flex flex-col z-50 transform -translate-x-full md:relative md:translate-x-0 shadow-2xl md:shadow-none">
        
        <button onclick="toggleSidebar()" class="absolute top-4 right-4 text-gray-400 md:hidden hover:text-white">
            <i class="fa-solid fa-xmark text-2xl"></i>
        </button>

        <div class="p-6 text-center border-b border-gray-800 mt-8 md:mt-0">
            <h1 class="font-display text-2xl text-gold font-bold tracking-wider">PAINEL<br><span class="text-white text-lg">ADMINISTRATIVO</span></h1>
        </div>
        
        <div class="p-4 flex items-center gap-3 bg-gray-900 mx-4 mt-6 rounded-lg border border-gray-800">
            <div class="w-10 h-10 rounded-full bg-gold text-darker flex items-center justify-center font-bold text-lg">B</div>
            <div>
                <p class="text-white font-bold text-sm">Barbeiro Chefe</p>
                <p class="text-xs text-green-500 flex items-center gap-1"><i class="fa-solid fa-circle text-[8px]"></i> Online</p>
            </div>
        </div>

        <nav class="flex-1 mt-8 px-4 space-y-2">
            <button onclick="switchAdminTab('dashboard')" id="btn-dashboard" class="w-full text-left p-3 rounded-lg bg-gold text-darker font-bold flex items-center gap-3 transition-transform hover:scale-105">
                <i class="fa-solid fa-table-columns"></i> Visão Geral
            </button>
            
            <button onclick="switchAdminTab('escala')" id="btn-escala" class="w-full text-left p-3 rounded-lg text-gray-400 hover:text-gold hover:bg-gray-800 flex items-center gap-3 transition-colors">
                <i class="fa-regular fa-calendar-check"></i> Gerenciar Escala
            </button>

            <button onclick="logout()" class="w-full text-left p-3 rounded-lg text-gray-400 hover:text-red-400 hover:bg-gray-800 flex items-center gap-3 transition-colors mt-auto mb-6">
                <i class="fa-solid fa-right-from-bracket"></i> Sair do Painel
            </button>
        </nav>

        <div class="p-4 text-center text-xs text-gray-600 border-t border-gray-800">
            v1.0.1 - Sistema Admin
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative overflow-hidden w-full">
        <div class="absolute top-0 right-0 w-full h-full opacity-5 pointer-events-none z-0">
             <img src="https://images.unsplash.com/photo-1628099003488-98aa1c9405e3?q=80&w=1287&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" class="w-full h-full object-cover">
        </div>

        <header class="h-16 md:h-20 border-b border-gray-800 bg-dark/95 backdrop-blur flex items-center justify-between px-4 md:px-8 z-10 shrink-0">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="text-gold text-2xl md:hidden hover:text-white transition-colors">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <h2 class="text-xl md:text-2xl font-display text-white">Dashboard</h2>
            </div>
            
            <div class="text-xs md:text-sm text-gray-400 text-right">
                <span id="current-date" class="block">Carregando...</span>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 z-10 w-full relative">
            
            <section id="admin-tab-dashboard" class="fade-in space-y-8">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                    <div class="bg-card border border-gray-800 p-6 rounded-xl shadow-lg relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-calendar-check text-5xl md:text-6xl text-gold"></i>
                        </div>
                        <p class="text-gray-400 text-xs md:text-sm uppercase tracking-wider mb-1">Agendamentos Hoje</p>
                        <h3 class="text-3xl md:text-4xl font-display text-white font-bold" id="stat-today">0</h3>
                    </div>

                    <div class="bg-card border border-gray-800 p-6 rounded-xl shadow-lg relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-sack-dollar text-5xl md:text-6xl text-green-500"></i>
                        </div>
                        <p class="text-gray-400 text-xs md:text-sm uppercase tracking-wider mb-1">Faturamento (Confirmado)</p>
                        <h3 class="text-3xl md:text-4xl font-display text-white font-bold text-green-400" id="stat-revenue">R$ 0,00</h3>
                    </div>

                    <div class="bg-card border border-gray-800 p-6 rounded-xl shadow-lg relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i class="fa-solid fa-users text-5xl md:text-6xl text-blue-500"></i>
                        </div>
                        <p class="text-gray-400 text-xs md:text-sm uppercase tracking-wider mb-1">Total de Clientes</p>
                        <h3 class="text-3xl md:text-4xl font-display text-white font-bold" id="stat-clients">0</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-card border border-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="font-display text-white mb-4">Desempenho Semanal</h3>
                        <canvas id="revenueChart"></canvas>
                    </div>
                    <div class="bg-card border border-gray-800 p-6 rounded-xl shadow-lg">
                        <h3 class="font-display text-white mb-4">Serviços Mais Pedidos</h3>
                        <canvas id="servicesChart"></canvas>
                    </div>
                </div>

                <div class="bg-card border border-gray-800 rounded-xl shadow-xl overflow-hidden flex flex-col h-auto max-h-[600px]">
                    <div class="p-4 md:p-6 border-b border-gray-800 flex flex-col sm:flex-row justify-between items-start sm:items-center shrink-0 bg-card z-10 gap-3 sm:gap-4">
                        <h3 class="font-display text-lg md:text-xl text-white">Todos os Agendamentos</h3>
                        
                        <div class="flex items-center gap-3 flex-wrap">
                            <label for="barber-filter" class="text-sm text-gray-400 hidden sm:block">Filtrar:</label>
                            <select id="barber-filter" onchange="filterAppointments()" class="bg-gray-700 text-white p-2 rounded-lg border border-gray-600 text-sm focus:ring-gold focus:border-gold">
                                </select>
                            <button onclick="loadDashboard()" class="text-gold hover:text-white transition-colors text-sm md:text-base"><i class="fa-solid fa-rotate-right"></i> <span class="hidden md:inline">Atualizar</span></button>
                        </div>
                        
                    </div>
                    
                    <div class="overflow-x-auto w-full">
                        <table class="w-full text-left border-collapse min-w-[800px] md:min-w-0">
                            <thead class="bg-gray-900 sticky top-0">
                                <tr class="text-gray-400 text-xs md:text-sm uppercase tracking-wider">
                                    <th class="p-3 md:p-4 font-medium">Data/Hora</th>
                                    <th class="p-3 md:p-4 font-medium">Cliente</th>
                                    <th class="p-3 md:p-4 font-medium">Profissional</th>
                                    <th class="p-3 md:p-4 font-medium">Serviços</th>
                                    <th class="p-3 md:p-4 font-medium">Valor</th>
                                    <th class="p-3 md:p-4 font-medium">Status</th>
                                    <th class="p-3 md:p-4 font-medium text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="appointments-table-body" class="text-sm divide-y divide-gray-800">
                                </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="h-12 md:hidden"></div>
            </section>
        
            <section id="admin-tab-escala" class="fade-in hidden max-w-4xl mx-auto">
                <h2 class="font-display text-3xl text-white mb-2">Configurar Escala</h2>
                <p class="text-gray-400 mb-8">Defina quais dias e horários estarão visíveis para os clientes.</p>

                <div class="bg-card border border-gray-800 p-6 rounded-xl shadow-lg mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-xs text-gold uppercase mb-1">1. Selecione o Barbeiro</label>
                            <select id="schedule-barber" class="w-full bg-input border border-gray-700 text-white p-3 rounded-lg focus:border-gold outline-none" onchange="loadSchedule()">
                                </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gold uppercase mb-1">2. Selecione a Data</label>
                            <input type="date" id="schedule-date" class="w-full bg-input border border-gray-700 text-white p-3 rounded-lg focus:border-gold outline-none" onchange="loadSchedule()">
                        </div>
                    </div>

                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <label class="block text-xs text-gold uppercase">3. Horários Disponíveis</label>
                            <div class="text-xs space-x-2">
                                <button onclick="toggleAllSlots(true)" class="text-green-500 hover:underline">Marcar Todos</button>
                                <button onclick="toggleAllSlots(false)" class="text-red-500 hover:underline">Desmarcar Todos</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 md:grid-cols-6 gap-3" id="schedule-slots">
                            </div>
                    </div>

                    <button onclick="saveSchedule()" class="w-full bg-gold hover:bg-yellow-600 text-darker font-bold py-3 rounded-lg transition-transform hover:scale-105">
                        SALVAR ESCALA
                    </button>
                </div>
                
                <div class="bg-blue-900/20 border border-blue-800 p-4 rounded-lg flex gap-3">
                    <i class="fa-solid fa-circle-info text-blue-400 mt-1"></i>
                    <p class="text-sm text-gray-300">
                        Se você desmarcar um horário aqui, ele sumirá instantaneamente do aplicativo do cliente. 
                        Use isso para folgas, pausas de almoço ou saídas antecipadas.
                    </p>
                </div>
            </section>

        </div>
    </main>

    <script>
    // 1. CONFIGURAÇÃO DA API (ATENÇÃO: SUBSTITUA PELA SUA URL DO RENDER APÓS O DEPLOY DO BACKEND)
    const API_URL = 'https://barbearia-api-xxxx.onrender.com'; // **MUDAR DEPOIS DE OBTER A URL**

    // VARIÁVEIS GLOBAIS
    let currentToken = localStorage.getItem('authToken');
    let currentUser = JSON.parse(localStorage.getItem('currentUser'));

    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    gold: '#d4af37',
                    dark: '#121212',
                    darker: '#0a0a0a',
                    card: '#1e1e1e',
                    input: '#2a2a2a',
                    success: '#10b981',
                    danger: '#ef4444'
                },
                fontFamily: {
                    sans: ['Roboto', 'sans-serif'],
                    display: ['Oswald', 'sans-serif'],
                }
            }
        }
    }

    const $ = selector => document.querySelector(selector);
    const $$ = selector => document.querySelectorAll(selector);
    
    // --- LÓGICA DE AUTENTICAÇÃO ---

    function checkAdminAuth() {
        if (!currentToken || !currentUser || currentUser.role !== 'admin') {
            alert('Acesso negado. Você não é um administrador.');
            window.location.href = 'index.html';
        } else {
            $('#userNameDisplay').innerText = currentUser.name;
            loadDashboard();
        }
    }

    function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html';
    }

    // --- LÓGICA DO DASHBOARD (MIGRADO PARA A API) ---
    
    async function loadDashboard() {
        const appointmentList = $('#appointments-list');
        appointmentList.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-400">Carregando agendamentos...</td></tr>';

        try {
            const response = await fetch(`${API_URL}/admin/appointments`, {
                headers: { 'Authorization': `Bearer ${currentToken}` }
            });

            if (response.status === 403) throw new Error('Não autorizado. Token inválido.');
            if (!response.ok) throw new Error('Falha ao carregar agendamentos.');

            const appointments = await response.json();
            
            if (appointments.length === 0) {
                appointmentList.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-400">Nenhum agendamento pendente encontrado.</td></tr>';
                return;
            }

            // Filtra por status: 'Confirmado' e 'Pendente' (se houver)
            const today = new Date().toISOString().split('T')[0];
            const filteredAppointments = appointments.filter(apt => apt.status === 'Confirmado');
            
            // Ordena por data e hora (mais próximos primeiro)
            filteredAppointments.sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return a.time.localeCompare(b.time);
            });

            // 4. Renderiza a tabela
            appointmentList.innerHTML = filteredAppointments.map(apt => {
                let statusBadge;
                switch(apt.status) {
                    case 'Confirmado':
                        statusBadge = '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-600 text-white">Confirmado</span>';
                        break;
                    case 'Concluído':
                        statusBadge = '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-success text-white">Concluído</span>';
                        break;
                    case 'Cancelado':
                        statusBadge = '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-danger text-white">Cancelado</span>';
                        break;
                    default:
                        statusBadge = apt.status;
                }

                const dateDisplay = new Date(apt.date + 'T' + apt.time).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' às ' + apt.time;

                return `
                    <tr class="border-t border-input hover:bg-card">
                        <td class="p-3 text-sm">${apt.name || 'Cliente'}</td>
                        <td class="p-3 text-sm">${apt.barber_name}</td>
                        <td class="p-3 text-sm">${dateDisplay}</td>
                        <td class="p-3 text-sm">${statusBadge}</td>
                        <td class="p-3 text-sm">
                            <div class="flex space-x-2 justify-end">
                                <button onclick="updateStatus(${apt.id}, 'Concluído')" title="Marcar como Concluído" class="w-7 h-7 md:w-8 md:h-8 rounded bg-success hover:bg-green-500 text-white flex items-center justify-center transition-colors shadow">
                                    <i class="fa-solid fa-check text-xs md:text-sm"></i>
                                </button>
                                <button onclick="updateStatus(${apt.id}, 'Cancelado')" title="Marcar como Cancelado" class="w-7 h-7 md:w-8 md:h-8 rounded bg-danger hover:bg-red-500 text-white flex items-center justify-center transition-colors shadow">
                                    <i class="fa-solid fa-xmark text-xs md:text-sm"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            updateStats(appointments); // Atualiza os gráficos/stats com os dados
        } catch (error) {
            console.error('Erro ao carregar dashboard:', error);
            appointmentList.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-danger">Erro ao carregar dados. Faça login novamente.</td></tr>';
            if (error.message.includes('Não autorizado')) {
                 setTimeout(() => logout(), 2000);
            }
        }
    }

    // Função que agora chama a API para atualizar o status
    async function updateStatus(aptId, newStatus) {
        if(!confirm(`Deseja alterar o status para ${newStatus}?`)) return;

        try {
            const response = await fetch(`${API_URL}/admin/appointments/status/${aptId}`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentToken}`
                },
                body: JSON.stringify({ status: newStatus })
            });

            const data = await response.json();

            if (response.ok) {
                alert(`Status atualizado para ${newStatus}.`);
                loadDashboard(); // Recarrega os dados
            } else {
                alert(`Falha ao atualizar status: ${data.message || 'Erro desconhecido.'}`);
            }
        } catch (error) {
            console.error('Erro de rede:', error);
            alert('Erro ao conectar com o servidor. Tente novamente.');
        }
    }

    // --- LÓGICA DE ESTATÍSTICAS (GRÁFICOS) ---

    let chartInstance = null;
    function updateStats(appointments) {
        // ... (Se você tinha lógica de gráficos, ela pode ser mantida aqui, 
        // mas agora usando a variável `appointments` que veio da API)
        // Por brevidade, vou focar apenas no que é crucial para o backend.
        // A lógica de filtragem e preparação de dados para o Chart.js deve vir aqui.
        
        const completedCount = appointments.filter(a => a.status === 'Concluído').length;
        const confirmedCount = appointments.filter(a => a.status === 'Confirmado').length;
        const canceledCount = appointments.filter(a => a.status === 'Cancelado').length;

        $('#stats-total').innerText = appointments.length;
        $('#stats-completed').innerText = completedCount;
        $('#stats-confirmed').innerText = confirmedCount;
        $('#stats-canceled').innerText = canceledCount;

        // Se houver lógica de Chart.js, garanta que `chartInstance` seja destruído antes de recriar.
    }


    // --- INICIALIZAÇÃO ---

    document.addEventListener('DOMContentLoaded', () => {
        checkAdminAuth();
        $('#logout-btn').addEventListener('click', logout);
    });
</script>
</body>
</html>
